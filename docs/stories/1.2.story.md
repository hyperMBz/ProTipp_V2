# Story 1.2: Real-time Data Infrastructure

## Story Information

- **Epic**: 1 - ProTipp V2 Professional Arbitrage Platform Enhancement
- **Story Number**: 1.2
- **Status**: Ready for Development
- **Priority**: High
- **Estimated Effort**: 6-10 hours
- **Dependencies**: Story 1.1 (Bookmaker API Integration Framework)

## User Story

**As a** user,
**I want** real-time odds updates with <100ms latency,
**so that** I can make informed betting decisions quickly.

## Acceptance Criteria

1. **WebSocket/SSE Infrastructure**: Real-time communication infrastructure
2. **Low Latency**: <100ms latency for odds updates
3. **Fallback Mechanism**: Polling fallback if real-time connection fails
4. **Connection Status**: Real-time connection status indicators
5. **Auto-reconnection**: Automatic reconnection logic with exponential backoff

## Integration Verification

- **IV1**: Existing polling-based updates continue to work
- **IV2**: Current arbitrage table displays real-time updates
- **IV3**: No disruption to existing user interface

## Dev Notes

### Previous Story Insights
- Bookmaker API integration framework must be complete
- Rate limiting patterns established from Story 1.1
- Fallback mechanisms already implemented
- **Existing WebSocket Implementation**: Basic Socket.io client already exists in `src/lib/api/real-time/websocket.ts`

### Data Models [Source: architecture.md#data-models]

**RealTimeConnectionModel**:
```typescript
interface RealTimeConnection {
  id: string;
  bookmaker_id: string;
  connection_type: 'websocket' | 'sse' | 'polling';
  status: 'connected' | 'connecting' | 'disconnected' | 'error';
  last_heartbeat: Date;
  latency_ms: number;
  error_count: number;
  last_error?: string;
  reconnect_attempts: number;
}
```

**RealTimeOddsUpdateModel**:
```typescript
interface RealTimeOddsUpdate {
  id: string;
  bookmaker_id: string;
  event_id: string;
  market: string;
  outcome: string;
  old_odds: number;
  new_odds: number;
  timestamp: Date;
  latency_ms: number;
  is_significant: boolean; // Significant odds movement
}
```

### API Specifications [Source: architecture.md#api-design]

**Real-time Odds WebSocket API**:
- **Endpoint**: `/api/v1/odds/realtime` (WebSocket)
- **Message Format**: JSON with odds updates
- **Heartbeat**: 30-second intervals (already implemented)
- **Reconnection**: Exponential backoff (1s, 2s, 4s, 8s, 16s) (already implemented)
- **Authentication**: JWT token validation for WebSocket connections
- **Rate Limiting**: 100 messages per minute per connection

**Connection Status API**:
- **Endpoint**: `/api/v1/realtime/status`
- **Method**: GET
- **Purpose**: Real-time connection status for all bookmakers
- **Authentication**: Required for sensitive connection data

### Component Specifications [Source: architecture.md#component-architecture]

**RealTimeEngine Component**:
- **Responsibility**: WebSocket/SSE connection management
- **Key Interfaces**: RealTimeManager, DataSync, FallbackHandler
- **Dependencies**: Bookmaker integration from Story 1.1
- **Technology Stack**: Socket.io (already in package.json), WebSocket, SSE

### File Locations [Source: architecture.md#source-tree-integration]

**New Files to Create**:
- `src/lib/api/real-time/sse.ts` - Server-Sent Events manager
- `src/lib/api/real-time/fallback.ts` - Polling fallback
- `src/lib/api/real-time/connection-manager.ts` - Connection management
- `src/lib/hooks/use-real-time.ts` - Real-time React hooks
- `src/components/real-time/RealTimeStatus.tsx` - Connection status
- `src/components/real-time/OddsStream.tsx` - Real-time odds display
- `src/components/real-time/ConnectionManager.tsx` - Connection management UI
- `src/app/api/v1/realtime/route.ts` - Real-time API endpoint
- `src/app/api/v1/realtime/status/route.ts` - Status endpoint

**Existing Files to Modify**:
- `src/lib/api/real-time/websocket.ts` - Enhance existing WebSocket manager with authentication and security
- `src/lib/hooks/use-odds-data.ts` - Integrate real-time updates
- `src/components/ArbitrageTable.tsx` - Add real-time indicators
- `src/app/page.tsx` - Add connection status to header

### Testing Requirements [Source: architecture.md#testing-strategy]

**Unit Tests**:
- WebSocket connection management tests
- SSE fallback mechanism tests
- Latency measurement tests
- Auto-reconnection logic tests
- Authentication and security tests

**Integration Tests**:
- Real-time data flow tests
- Fallback mechanism integration tests
- Performance impact tests
- Security validation tests

**Test Files to Create**:
- `src/lib/api/real-time/__tests__/websocket.test.ts`
- `src/lib/api/real-time/__tests__/connection-manager.test.ts`
- `src/components/real-time/__tests__/RealTimeStatus.test.tsx`

### Technical Constraints [Source: architecture.md#technical-constraints]

- **Latency Requirement**: <100ms for odds updates
- **Browser Compatibility**: WebSocket and SSE support
- **Fallback Strategy**: Polling when real-time fails
- **Performance**: No impact on existing arbitrage calculations
- **Error Handling**: Graceful degradation with user feedback

### Security Considerations [Source: architecture.md#security-requirements]

**Authentication & Authorization**:
- JWT token validation for all WebSocket connections
- Rate limiting: 100 messages per minute per connection
- Connection authentication on initial handshake
- Session-based access control for real-time data

**Data Protection**:
- Input validation for all real-time messages
- Sanitization of odds data before processing
- Encryption of sensitive connection data
- Audit logging for all real-time connections

**Vulnerability Prevention**:
- WebSocket connection origin validation
- Protection against message flooding attacks
- Secure reconnection mechanisms
- Error message sanitization to prevent information leakage

**Compliance Requirements**:
- GDPR compliance for real-time data processing
- Financial data protection standards
- Audit trail for all odds updates
- Data retention policies for real-time logs

## Tasks / Subtasks

### Task 1: Enhance WebSocket Infrastructure (AC: 1, 2)
1. Enhance `src/lib/api/real-time/websocket.ts` - Add authentication and security features
2. Implement JWT token validation for WebSocket connections
3. Add rate limiting and message validation
4. Enhance latency measurement and monitoring
5. **Unit Test**: Test WebSocket authentication and security features

### Task 2: Implement SSE Fallback (AC: 1, 3)
1. Create `src/lib/api/real-time/sse.ts` - SSE manager
2. Implement SSE connection with event handling
3. Add fallback logic when WebSocket fails
4. Create connection status monitoring
5. **Unit Test**: Test SSE connection and fallback

### Task 3: Create Polling Fallback (AC: 3)
1. Create `src/lib/api/real-time/fallback.ts` - Polling fallback
2. Implement polling when real-time connections fail
3. Add exponential backoff for reconnection attempts
4. Create seamless transition between real-time and polling
5. **Unit Test**: Test polling fallback mechanism

### Task 4: Create Connection Manager (AC: 4, 5)
1. Create `src/lib/api/real-time/connection-manager.ts` - Centralized management
2. Implement connection status tracking for all bookmakers
3. Add auto-reconnection with exponential backoff
4. Create connection health monitoring
5. **Unit Test**: Test connection manager functionality

### Task 5: Create React Hooks (AC: 2, 4)
1. Create `src/lib/hooks/use-real-time.ts` - Real-time data hooks
2. Integrate with existing TanStack Query patterns
3. Add connection status and latency monitoring hooks
4. Create real-time odds update hooks
5. **Unit Test**: Test React hooks functionality

### Task 6: Create Real-time UI Components (AC: 4)
1. Create `src/components/real-time/RealTimeStatus.tsx` - Connection status
2. Create `src/components/real-time/OddsStream.tsx` - Real-time odds display
3. Create `src/components/real-time/ConnectionManager.tsx` - Management UI
4. Integrate with existing shadcn/ui patterns
5. **Unit Test**: Test UI components

### Task 7: Create API Endpoints (AC: 4, 5)
1. Create `src/app/api/v1/realtime/route.ts` - WebSocket endpoint
2. Create `src/app/api/v1/realtime/status/route.ts` - Status endpoint
3. Add authentication and authorization
4. Implement error handling and response formatting
5. **Integration Test**: Test API endpoints

### Task 8: Integrate with Existing System (IV1, IV2, IV3)
1. Modify `src/lib/hooks/use-odds-data.ts` to use real-time updates
2. Update `src/components/ArbitrageTable.tsx` with real-time indicators
3. Add connection status to main dashboard header
4. Ensure existing polling continues to work
5. **Integration Test**: Verify no disruption to existing functionality

## Success Criteria

- ✅ WebSocket/SSE infrastructure provides <100ms latency
- ✅ Polling fallback works when real-time connections fail
- ✅ Connection status indicators show real-time status
- ✅ Auto-reconnection works with exponential backoff
- ✅ Existing polling-based updates continue to work
- ✅ Current arbitrage table displays real-time updates
- ✅ No disruption to existing user interface
- ✅ Performance impact is minimal (<5% degradation)
- ✅ Security requirements are met (authentication, rate limiting, data protection)

## Risk Mitigation

- **Connection Stability**: Multiple fallback mechanisms (WebSocket → SSE → Polling)
- **Latency Issues**: Continuous monitoring and optimization
- **Browser Compatibility**: Progressive enhancement approach
- **Performance Impact**: Thorough testing and optimization
- **Integration Complexity**: Incremental implementation with testing
- **Security Vulnerabilities**: Comprehensive security testing and validation
- **Authentication Failures**: Graceful fallback to polling mode

## Dev Agent Record

### Agent Model Used
BMad Master - Story Validation and Enhancement

### Debug Log References
- Story validation completed with security enhancements
- Socket.io usage verified against existing package.json
- API specifications aligned with existing codebase

### Completion Notes List
- ✅ Template completeness validation passed
- ✅ File structure and source tree validation passed  
- ✅ UI/Frontend completeness validation passed
- ✅ Acceptance criteria satisfaction assessment passed
- ✅ Validation and testing instructions review passed
- ✅ Security considerations added (was missing)
- ✅ Tasks/subtasks sequence validation passed
- ✅ Anti-hallucination verification completed
- ✅ Dev agent implementation readiness confirmed
- ✅ Story status updated to "Ready for Development"

### File List
**Modified Files**:
- `docs/stories/1.2.story.md` - Enhanced with security considerations and validation fixes

**Existing Files Referenced**:
- `src/lib/api/real-time/websocket.ts` - Existing Socket.io implementation
- `package.json` - Socket.io dependency verification
- `src/lib/api/odds-api.ts` - Existing odds API structure

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | BMad Master |
| 2024-12-19 | 1.1 | Added security considerations and validation fixes | BMad Master |
